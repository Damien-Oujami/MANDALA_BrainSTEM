# .btc_reserve.yaml
# Tekita / BrainSTEM â€” Bitcoin Treasury Automation
# Purpose: Automate disciplined BTC accumulation + agent rails without risking ops.

version: 1

meta:
  owner: Tekita Treasury
  description: "DCA-based BTC reserve with strict runway + risk guardrails."
  last_review: 2025-08-24

environment:
  # choose: "prod" | "staging" | "dev"
  name: "staging"

custody:
  # choose ONE active mode
  mode: "self_custody"   # "self_custody" | "custodial_exchange"
  self_custody:
    # strongly recommended: multisig (2-of-3)
    scheme: "multisig_2of3"
    cosigners:
      - "xpub_1_PLACEHOLDER"
      - "xpub_2_PLACEHOLDER"
      - "xpub_3_PLACEHOLDER"
    # cold storage address for long-term reserves (no spending keys online)
    cold_storage_address: "bc1qPLACEHOLDER..."
    policy:
      rotation_days: 180
      allowed_utxo_consolidation: true
      spending_requires:
        min_signers: 2
        timelock_blocks: 0
  custodial_exchange:
    # if you must use an exchange for on-ramps only; immediately sweep to cold storage
    venue: "coinbase"              # e.g., coinbase | kraken | river | swan
    api_key_env: "EXCHANGE_API_KEY"
    api_secret_env: "EXCHANGE_API_SECRET"
    auto_sweep_to_cold_storage: true
    sweep_threshold_btc: 0.02

wallets:
  hot_wallet:
    purpose: "Lightning + agent micropayments"
    type: "lnbits"                 # lnbits | lnd | core-lightning
    node_uri: "ln://PLACEHOLDER"
    min_balance_sats: 500000       # 0.005 BTC buffer
    refill_from_cold_above_sats: 2000000
  cold_wallet:
    purpose: "Treasury reserve (HODL)"
    address: "bc1qPLACEHOLDER..."  # receiving vault address
    min_confirmations: 3

policy:
  # ---- SAFETY FIRST ----
  usd_runway:
    # keep at least X months of operating expenses in USD before buying BTC
    min_months: 6
    # if runway < min, DCA pauses automatically
    pause_when_below_min: true

  allocation:
    # target BTC as % of total liquid treasury (USD + BTC at mark-to-market)
    target_pct: 20
    max_pct_cap: 40                 # hard ceiling
    rebalance:
      # if BTC > max_pct_cap, auto-sell excess back to USD (optional)
      enabled: false

  dca:
    cadence: "weekly"               # daily | weekly | biweekly | monthly
    day_of_week: "Mon"              # used when cadence=weekly
    time_utc: "14:00"               # 24h format
    notional_usd: 1000              # base DCA amount
    smart_dca:
      enabled: true
      # buy more on drawdowns; throttle on spikes
      drawdown_scale:
        - { threshold_pct: -5,  multiplier: 1.25 }
        - { threshold_pct: -10, multiplier: 1.50 }
        - { threshold_pct: -20, multiplier: 2.00 }
      overbought_throttle:
        - { threshold_pct:  +8, multiplier: 0.50 }
        - { threshold_pct: +15, multiplier: 0.25 }
      lookback_days: 7

  risk_limits:
    max_single_order_usd: 5000
    max_daily_spend_usd: 7000
    halt_triggers:
      # automatic PAUSE conditions
      - name: "btc_intraday_spike"
        condition: "price_change_24h_pct >= 20"
      - name: "ops_runway_breach"
        condition: "usd_runway_months < 6"
      - name: "custody_anomaly"
        condition: "wallet_mismatch OR failed_sweep"

  fees:
    # prioritize reliability over speed; use mempool smart fee API if available
    onchain_sats_per_vb: "auto"

  reporting:
    currency: "USD"
    mark_to_market_source: "coingecko"  # coingecko | coinbase | kraken
    deliver:
      - channel: "slack"
        webhook_env: "SLACK_TREASURY_WEBHOOK"
      - channel: "email"
        to: ["finance@tekita.ai","ops@tekita.ai"]
    cadence: "daily"
    include:
      - "btc_position"
      - "runway_calc"
      - "recent_buys"
      - "P&L_30d"
      - "alerts_last_24h"

agents:
  # budgets & guardrails for AI agents using Lightning
  enable_agent_wallets: true
  per_agent_daily_budget_sats: 20000      # ~0.0002 BTC
  allowed_merchants:
    - "compute.market"
    - "api.zaps.internal"
  disallowed_categories:
    - "gambling"
    - "mixers"
  approval:
    requires_human_for_tx_over_sats: 100000
  audit:
    export_csv_daily: true
    retain_days: 365

lightning:
  # channel strategy for m2m micropayments
  node: "lnbits"
  open_channels:
    target_capacity_sats: 10000000        # ~0.1 BTC total LN liquidity
    peers:
      - pubkey: "02abcdef...peer1"
        min_capacity_sats: 2000000
      - pubkey: "03abcdef...peer2"
        min_capacity_sats: 2000000
  auto_rebalance: true
  route_hints_enabled: true

compliance:
  # keep this minimal but explicit
  kyc_aml:
    # use exchange KYC for on-ramp only; treasury held self-custodied
    source_of_funds: "Operating revenue"
    tx_screening: "onramp_only"
  accounting:
    method: "FIFO"                  # FIFO | LIFO | specific_id
    close_period_days: 30
  audit_trail:
    log_to: "s3://tekita-treasury-logs"   # or local path
    redact_keys: true

secrets:
  # NEVER commit real secrets. Use env vars in CI or local agent.
  # These names should exist in your execution environment.
  exchange_api_key: "${EXCHANGE_API_KEY}"
  exchange_api_secret: "${EXCHANGE_API_SECRET}"
  slack_webhook: "${SLACK_TREASURY_WEBHOOK}"

profiles:
  # quick switches for different risk postures
  conservative:
    allocation:
      target_pct: 10
      max_pct_cap: 20
    dca:
      cadence: "biweekly"
      notional_usd: 500
  standard:
    allocation:
      target_pct: 20
      max_pct_cap: 35
    dca:
      cadence: "weekly"
      notional_usd: 1000
  aggressive:
    allocation:
      target_pct: 30
      max_pct_cap: 40
    dca:
      cadence: "weekly"
      notional_usd: 2000
      smart_dca:
        enabled: true
        drawdown_scale:
          - { threshold_pct: -5,  multiplier: 1.5 }
          - { threshold_pct: -10, multiplier: 2.0 }
          - { threshold_pct: -20, multiplier: 3.0 }
